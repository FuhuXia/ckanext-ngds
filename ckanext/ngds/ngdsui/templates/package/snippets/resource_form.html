{% include 'package/resource_form_template.tmf' %}
{% include 'package/add_responsible_party.tmf' %}

{% if include_metadata %}

{{ data }}

{% endif %}
<script>
{% if data %}
    resource_location = window.location.origin+"{{data['resource_location']}}";
{% endif %}
</script>
<form id="file-upload-form" action="/ngds/contribute/upload_file" method="post" enctype="multipart/form-data">
  <div id="file-upload" style="display:none;">
          <input type="submit" name="file-upload-button" value="Upload"></input>
          <input type="file" id="file" name="file" class="structured-input"></input>
          {% if data['key'] %}
          <input type="hidden" name="key" id="key1" value="{{data['key']}}"></input>
          {% else %}
          <input type="hidden" name="key" id="key1"></input>
          {% endif %}
          <input type="hidden" name="dataset_name" value="{{pkg_name}}"/>
          <input type="hidden" name="resource_type" id="resource_type"/>
  </div>
</form>

<form class="dataset-form dataset-resource-form form-horizontal" action="/dataset/new_resource/{{pkg_name}}" method="post" data-module="resource-form basic-form">
  <ol class="stages stage-2">
    <li class="first-stage complete">
        <button class="highlight" name="save" value="go-dataset" type="submit">1. Create dataset</button>
    </li>
    <li class="middle-stage active">
        <span class="highlight">2. Add Resources</span>
    </li>
    <li class="last-stage uncomplete">
        <span class="highlight">3. Dataset Metadata</span>
    </li>
  </ol>

  <div class="main-controls">
      <div class="radio-section">
        <input type="hidden" name="dataset_name" value="{{pkg_name}}"/>
        <input type="radio" id="resource_type-selection" name="upload_type_selection" value="upload_type"/>
        <label for="resource_type-selection">Upload a file</label><br/>
          {% if data['resource_type'] %}          
          <input type="hidden" name="resource_type" value="{{data['resource_type']}}" />
        &nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" id="resource_type-structured" class="resource_type" />
          {% else %}
        &nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" id="resource_type-structured" class="resource_type" name="resource_type" value="structured"/>
          {% endif %}

        <label for="resource_type-structured" id="resource_type-structured-label">Structured</label><br/>
          {% if data['resource_type'] %}
          &nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" id="resource_type-unstructured" class="resource_type" />
          {% else %}
          &nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" id="resource_type-unstructured" class="resource_type" name="resource_type" value="unstructured"/>
          {% endif %}
        <label for="resource_type-unstructured" id="resource_type-unstructured-label">Unstructured</label>
      </div>

      <div class="radio-section">
        {% if data['resource_type'] %}
        <input type="radio" id="data-service" />
        {% else %}
          <input type="radio" id="data-service" name="resource_type" value="data-service" />
        {% endif %}
        <label for="data-service">Link to a data service</label>
      </div>

      <div class="radio-section">
          {% if data['resource_type'] %}
        <input type="radio" id="offline-resource" />
         {% else %}
         <input type="radio" id="offline-resource" name="resource_type" value="offline-resource" />
          {% endif %}
        <label for="offline-resource">Offline resource</label>
      </div>

      {% if data['id'] %}
        <input type="hidden" name="id" value="{{data['id']}}" />
      {% endif %}


  </div>

  <div class="form-body">
   <!-- Offline Resource End -->

  </div>
  <div class="form-actions">
    {% block delete_button %}
      {% if data.id %}
        {% if h.check_access('resource_delete', {'id': data.id})  %}
          {% set locale = h.dump_json({'content': _('Are you sure you want to delete this resource?')}) %}
          <a class="btn btn-danger pull-left" href="{% url_for controller='package', action='resource_delete', resource_id=data.id, id=pkg_name %}" data-module="confirm-action" data-module-i18n="{{ locale }}">{% block delete_button_text %}{{ _('Delete') }}{% endblock %}</a>
        {% endif %}
      {% endif %}
    {% endblock %}
    {% if stage %}
        {% block previous_button %}
        <button type="submit" name="save" value="go-dataset">Previous Page</button>
        {% endblock %}
        {% block again_button %}
        <button type="submit" name="save" value="again">Save and Add Another</button>
        {% endblock %}
        <button type="button" class="{% block pull_right %}{% endblock %}" id="go-metadata">{% block save_button_text %}{{ _('Next: Additional Metadata') }}{% endblock %}</button>
        <!-- <button type="button" name="save" value="go-metadata">Additional Metadata</button> -->
        {% endif %}
    </div>
</form>

{% raw %}
<script type="text/javascript" src="/scripts/contribute/responsible_party.js"></script>
<script type="text/javascript" src="/scripts/contribute/resource_form_fields.js"></script>
<script type="text/javascript" src="/scripts/autocomplete.js"></script>
<script type="text/javascript" src="/scripts/contribute/resource_form.js"></script>

<script>

var render_forms = function(value) {
  $(".form-body").empty();
  
  position_file_uploader();

  if(value==='structured' || value==='unstructured') {
      $("[name=upload_type_selection]").prop("checked",true);
  }
  else {
      $("[name=upload_type_selection]").prop("checked",false); 
  }
console.log(value);
  if(value==="structured") {
    $("#resource_type-structured").prop("checked",true);
    $(".form-body").html(Mustache.render(ngds.structured_form_template,structured_form));
    position_file_uploader("#url");
    populate_content_models();
  }

  if(value==="unstructured") {
    $("#resource_type-unstructured").prop("checked",true);
    $(".form-body").html(Mustache.render(ngds.structured_form_template,unstructured_form));
    position_file_uploader("#url");
  }

  if(value==="offline-resource") {
    $("#offline-resource").prop("checked",true);
    $(".form-body").html(Mustache.render(ngds.structured_form_template,offline_resource_form));
  }

  if(value==="data-service") {
    $(".form-body").html(Mustache.render(ngds.structured_form_template,link_data_service_form));
  }

  if(value==="data-service" || value==="unstructured" || value==="structured") {
    // var dist_autocomp = ngds.autocomplete(".distributor-fake","/responsible_parties",'q',['name','email'],'name'); 
    // dist_autocomp.proxy(".distributor_name","name"); 
    // dist_autocomp.proxy(".distributor_email","email");
    // dist_autocomp.proxy(".distributor",function(dict) {
    //   $(".distributor").val(JSON.stringify({
    //     "distributor_name":dict.name,
    //     "distributor_email":dict.email
    //   }));
    // });  
console.log($("#distributor_name"));
console.log($("#distributor_email"));
    console.log("here");
    new ngds.responsible_party().responsibilify({
      'rs_name':'#distributor_name',
      'rs_email':'#distributor_email',
      'rs_fake':'#distributor_fake',
      'rs':'#distributor',
      'slug_container':'.distributor-tag'
    });
  }
};

$('input[name="resource_type"]').on('change',function(ev){
  
  var id = ev.currentTarget.id;
  var value ="";
  if(id==="resource_type-unstructured") {
    value='unstructured';
  }
  if(id==="resource_type-structured") {
    value='structured';
  }
  if(id==="offline-resource") {
    value='offline-resource';
  }
  if(id==="data-service") {
    value='data-service';
  }

  render_forms(value);
});

$("#go-metadata").click(function() {
  $.ajax({
    'url':'/ngds/contribute/validate_resource',
    'data':$(".dataset-form").serializeArray(),
    'success':function(response) {
      if(response.success===true) {
        $(".dataset-form").append($("<input/>",{'type':'hidden','name':'save','value':'go-metadata'}));
        // $(".dataset-form").append($("<input/>",{'type':'hidden','name':'id','value':''}));
        $(".dataset-form").submit();
      }
      else {
        ngds.publish('Notifications.received',response);
      }
    }
  });
});


if(typeof continuation!=='undefined') {
  for(var i=0;i<continuation.length;i++) {
    $("[name="+continuation['field']+"]").val(continuation['value']);
  }
}

</script>
{% endraw %}

<script>

(function template_variables_collect(){
  {% if data %}
  console.log("Activate populate");
   data="{{data}}";
   data = ngds.util.parse_raw_json("{{h.jsonify(data)}}")
   activate_populate_form(data);
  {% endif %}
})();


</script>