<script>
{% if data %}
    resource_location = window.location.origin+"{{data['resource_location']}}";
{% endif %}
</script>
<form id="file-upload-form" action="/ngds/contribute/upload_file" method="post" enctype="multipart/form-data">
  <div id="file-upload" style="display:none;">
          <input type="submit" name="file-upload-button" value="Upload"></input>
          <input type="file" id="file" name="file" class="structured-input"></input>
          {% if data['key'] %}
          <input type="hidden" name="key" id="key1" value="{{data['key']}}"></input>
          {% else %}
          <input type="hidden" name="key" id="key1"></input>
          {% endif %}
          <input type="hidden" name="dataset_name" value="{{pkg_name}}"/>
          <input type="hidden" name="form_type" id="form_type"/>
  </div>
</form>

{{ h.get_rating(package_id) }}

<form class="dataset-form dataset-resource-form form-horizontal" action="/dataset/new_resource/{{pkg_name}}" method="post" data-module="resource-form basic-form">
  <ol class="stages stage-2">
    <li class="first-stage complete">
        <button class="highlight" name="save" value="go-dataset" type="submit">1. Create dataset</button>
    </li>
    <li class="middle-stage active">
        <span class="highlight">2. Add Resources</span>
    </li>
    <li class="last-stage uncomplete">
        <span class="highlight">3. Dataset Metadata</span>
    </li>
  </ol>

  <div class="main-controls">
      <div class="radio-section">
        <input type="hidden" name="dataset_name" value="{{pkg_name}}"/>
        <input type="radio" id="upload-type-selection" name="upload_type_selection" value="upload_type"/>
        <label for="upload-type-selection">Upload a file</label><br/>
        &nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" id="upload-type-structured" class="upload-type" name="upload-type" value="structured"/>
        <label for="upload-type-structured" id="upload-type-structured-label">Structured</label><br/>
        &nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" id="upload-type-unstructured" class="upload-type" name="upload-type" value="unstructured"/>
        <label for="upload-type-unstructured" id="upload-type-unstructured-label">Unstructured</label>
      </div>

      <div class="radio-section">
        <input type="radio" id="data-service" name="upload-type" value="data-service" />
        <label for="data-service">Link to a data service</label>
      </div>

      <div class="radio-section">
        <input type="radio" id="offline-resouece" name="upload-type" value="offline-resource" />
        <label for="offline-resource">Offline resource</label>
      </div>
  </div>

  <div class="form-body">
   <!-- Offline Resource End -->

   <!-- <div class="input-group">
        <div class="sp-label"><label>Distributor</label></div>
        <input type="text" name="distributor" id="structured_distributor" class="structured-input"></input>
      </div> -->

  </div>
  <div class="form-actions">
        <button type="submit" name="save" value="go-dataset">Previous Page</button>
        <button type="submit" name="save" value="go-dataset">Save and Add Another</button>
        <button type="button" id="go-metadata">Additional Metadata</button>
        <!-- <button type="button" name="save" value="go-metadata">Additional Metadata</button> -->
    </div>
</form>

{% raw %}
<script>
var structured_form = {
  'form':[
    {
      'label':'Resource URL',
      'name':'url',
      'tag':'input',
      'additional':function() {
        return 'type=text id=url';
      }
    },
    {
      'label':'Name',
      'name':'name',
      'tag':'input',
      'additional':function() {
        return 'type=text';
      }
    },
    {
      'label':'Content Model',
      'name':'content_model',
      'top_classes':function() {
        return "content_model_marker";
      },
      'tag':'select',
      'id':function() {
        return 'id=content_model';
      }
    },
    {
      'label':'Description',
      'name':'description',
      'tag':'textarea',
      'id':function() {
        return 'id=description';
      },
      'additional':function() {
        return 'rows=4 cols=1'
      },
      'classes':function() {
        return 'description-label-div';
      }
    },
    {
      'label':'Distributor',
      'name':'distributor',
      'tag':'input',
      'additional':function() {
        return 'type=text';
      }
    },
    {
    'label':'Format',
    'name':'format',
    'tag':'input',
    'additional':function() {
      return 'type=text';
      }
    }
  ]
};

var unstructured_form = {
  'form':[
    {
      'label':'Resource URL',
      'name':'url',
      'tag':'input',
      'additional':function() {
        return 'type=text id=url';
      }
    },
    {
      'label':'Name',
      'name':'name',
      'tag':'input',
      'additional':function() {
        return 'type=text';
      }
    },
    {
      'label':'Description',
      'name':'description',
      'tag':'textarea',
      'id':function() {
        return 'id=description';
      },
      'additional':function() {
        return 'rows=4 cols=1'
      },
      'classes':function() {
        return 'description-label-div';
      }
    },
    {
      'label':'Distributor',
      'name':'distributor',
      'tag':'input',
      'additional':function() {
        return 'type=text';
      }
    },
    {
    'label':'Format',
    'name':'format',
    'tag':'input',
    'additional':function() {
      return 'type=text';
      }
    }
  ]
};


var offline_resource_form = {
  'form':[
    {
      'label':'Resource URL',
      'name':'url',
      'tag':'input',
      'additional':function() {
        return 'type=text id=url';
      }
    },
    {
      'label':'Name',
      'name':'name',
      'tag':'input',
      'additional':function() {
        return 'type=text';
      }
    },
    {
      'label':'Description',
      'name':'description',
      'tag':'textarea',
      'id':function() {
        return 'id=description';
      },
      'additional':function() {
        return 'rows=4 cols=1'
      },
      'classes':function() {
        return 'description-label-div';
      }
    },
    {
    'label':'Ordering Procedure',
    'name':'ordering_procedure',
    'tag':'textarea',
    'additional':function() {
        return 'rows=4 cols=1'
      },
    'classes':function() {
        return 'description-label-div';
      }
    }
  ]
};

var link_data_service_form = {
  'form':[
    {
      'label':'Resource URL',
      'name':'url',
      'tag':'input',
      'additional':function() {
        return 'type=text id=url';
      }
    },
    {
      'label':'Name',
      'name':'name',
      'tag':'input',
      'additional':function() {
        return 'type=text';
      }
    },
    {
      'label':'Description',
      'name':'description',
      'tag':'textarea',
      'id':function() {
        return 'id=description';
      },
      'additional':function() {
        return 'rows=4 cols=1'
      },
      'classes':function() {
        return 'description-label-div';
      }
    },
    {
      'label':'Distributor',
      'name':'distributor',
      'tag':'input',
      'additional':function() {
        return 'type=text';
      }
    },
    {
    'label':'Protocol',
    'name':'protocol',
    'tag':'input',
    'additional':function() {
      return 'type=text';
      }
    },
    {
    'label':'Layer',
    'name':'layer',
    'tag':'input',
    'additional':function() {
      return 'type=text';
      }
    }
  ]
};


var position_file_uploader = function(selector) {
  if(typeof selector==='undefined') {
    $("#file-upload").hide();
    return;
  }
  var ref = $(selector);
  var r_width = ref.width();
  var file_upload = $("#file-upload");
  file_upload.css("position","absolute");
  ref.css("width",r_width-60);
  file_upload.css("left",ref.position().left+ref.width()+5);
  file_upload.css("top",ref.position().top);
  file_upload.show();
};

var structured_form_template = "{{#form}}\
        <div class=\"input-group {{top_classes}}\">\
            <div class=\"sp-label {{classes}}\"><label>{{label}}</label></div>\
            <{{tag}} {{additional}} name=\"{{name}}\" {{id}} class=\"structured-input\" {{placeholder}}>{{inner}}</{{tag}}>\
        </div>\
{{/form}}";


var render_forms = function(value) {
  $(".form-body").empty();
  
  position_file_uploader();

  if(value==='structured' || value==='unstructured') {
      $("[name=upload_type_selection]").prop("checked",true);
  }
  else {
      $("[name=upload_type_selection]").prop("checked",false); 
  }

  if(value==="structured") {
    $("#upload-type-structured").prop("checked",true);
    $(".form-body").html(Mustache.render(structured_form_template,structured_form));
    position_file_uploader("#url");
    populate_content_models();
  }

  if(value==="unstructured") {
    $("#upload-type-unstructured").prop("checked",true);
    $(".form-body").html(Mustache.render(structured_form_template,unstructured_form));
    position_file_uploader("#url");
  }

  if(value==="offline-resource") {
    $(".form-body").html(Mustache.render(structured_form_template,offline_resource_form));
  }

  if(value==="data-service") {
    $(".form-body").html(Mustache.render(structured_form_template,link_data_service_form));
  }
};

$('input[name="upload-type"]').on('change',function(ev){
  
  var value = ev.target.value;

  render_forms(value);
});

$("#go-metadata").click(function() {
  $.ajax({
    'url':'/ngds/contribute/validate_resource',
    'data':$(".dataset-form").serializeArray(),
    'success':function(response) {
      if(response.success===true) {
        $(".dataset-form").append($("<input/>",{'type':'hidden','name':'save','value':'go-metadata'}));
        $(".dataset-form").append($("<input/>",{'type':'hidden','name':'id','value':''}));
        $(".dataset-form").submit();
      }
    }
  });
});


if(typeof continuation!=='undefined') {
  for(var i=0;i<continuation.length;i++) {
    $("[name="+continuation['field']+"]").val(continuation['value']);
  }
}

</script>
{% endraw %}

<script type="text/javascript" src="/scripts/contribute/resource_form.js"></script>


<script>

(function template_variables_collect(){
  {% if data %}
   data="{{data}}";
   data=data.replace(/u&#39;/g,'\"');
   data=data.replace(/&#39;/g,'\"');
   data=JSON.parse(data);
   activate_populate_form(data);
  {% endif %}
})();


</script>