/* Copyright (c) 2014, Siemens Corporate Technology and Arizona Geological Survey */(function(){var e=new L.FeatureGroup;ngds.Map={map:L.map("map-container",{center:[39.977,-97.646],zoom:4,maxBounds:[[-84,-179],[84,179]],attributionControl:!0,minZoom:2}),layers:{baseLayer:L.tileLayer("http://otile{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpeg",{subdomains:"1234",attribution:'Tiles Courtesy of <a href="http://www.mapquest.com/">MapQuest</a> &mdash; Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',detectRetina:!0}),searchResultsGroup:{"Search Results":L.layerGroup()},dataExtentsGroup:{"Data Extents":new Array},wmsLayersGroup:new Array},controls:{loading:L.Control.loading({separate:!0,position:"topleft"}),doodle:new L.Control.Draw({position:"topleft",draw:{polyline:!1,circle:!1,marker:!1,polygon:!1},edit:{featureGroup:e,remove:!1,edit:!1}}),reset:L.Control.extend({options:{position:"topleft"},onAdd:function(){var e=L.DomUtil.create("div","ngds-custom-control reset-control");L.DomEvent.on(e,"click",L.DomEvent.stopPropagation).on(e,"dblclick",L.DomEvent.stopPropagation).on(e,"mousedown",L.DomEvent.stopPropagation).addListener(e,"click",function(){ngds.Map.map.setView([39.977,-97.46],4)});$(e).append('<a class="glyphicon icon-globe" href="#" title="Reset extent"></a>');return e}})},searchParameters:{q:"",extras:"undefined",page:"undefined"}};ngds.Map.topLevelSearch=function(e){e||(e=ngds.Map.searchParameters);e.page==="undefined"&&(e.page=1);e.extras==="undefined"&&(e.extras={ext_bbox:"-180,-90,180,90"});var t=ngds.Map.layers.searchResultsGroup["Search Results"];t.getLayers().length>1&&t.clearLayers();$("#query-results #search-results").empty();if(e.q.length===0){var n=$("#map-search-query").val();e.q=n}else $("#map-search-query").val(e.q);ngds.Map.makeSearch(e);$("#content-legend-menu").addClass("shown")};ngds.Map.makeSearch=function(e){var t=ngds.ckanlib.package_search,n=50,r=parseInt(e.page),i=(r-1)*n,s=e.q+"+res_url:*+",o=e.extras;t({q:s,rows:n,start:i,extras:o},function(e){var t=e.result.count,i=r+1,s=i*n;if(t===0){var o='<div class="top-showing-results">No Search Results</div>';$("#query-results .query-hit-count").empty();$("#query-results .query-hit-count").append(o)}else if(t<50&&r===1){var o='<div class="top-showing-results">Results 1 - '+t+" of "+t+"</div>";$("#query-results .query-hit-count").empty();$("#query-results .query-hit-count").append(o)}else if(t!=0&&r===1){var o='<div class="top-showing-results">Results 1 - 50 of '+t+"</div>";$("#query-results .query-hit-count").empty();$("#query-results .query-hit-count").append(o)}else{var o='<div class="top-showing-results"> '+t+" Total Results</div>";$("#query-results .query-hit-count").empty();$("#query-results .query-hit-count").append(o)}_.each(e.result.packages,function(e){var t=Math.floor(Math.random()*1e21),n=JSON.parse(e.bbox[0]),r={sw_lat:n.coordinates[0][0][1],sw_lon:n.coordinates[0][0][0],ne_lat:n.coordinates[0][2][1],ne_lon:n.coordinates[0][2][0]},i=r.sw_lat+","+r.sw_lon+","+r.ne_lat+","+r.ne_lon;bounds=L.latLngBounds([[r.sw_lon,r.sw_lat],[r.ne_lon,r.ne_lat]]),center=bounds.getCenter(),geojson={type:"Feature",properties:{feature_id:t,title:e.title},geometry:{type:"Point",coordinates:[center.lat,center.lng]}},reqData={title:e.title,name:e.name,notes:e.notes,pkg_id:e.id,resources:e.resources,geoData:r,geojson:geojson,geoString:i};ngds.Map.returnSearchResult(reqData)});if(t>0&&n<t&&e.result.packages.length>0){var o='<div id="load-results-'+i+'" class="load-more-results">';o+='<a href="javascript:void(0)" value="'+i+"-"+s+"-"+n+'" onclick="ngds.Map.doPagination(this)">Load Results '+(n*(i-1)+1)+" - "+s+"</a>";o+="</div>";$("#query-results #search-results").append(o)}else{var o='<div class="top-showing-results">No More Search Results</div>';$("#query-results #search-results").append(o)}});e.q=""};ngds.Map.returnSearchResult=function(e){var t=[e],n=_.map(t,function(t){if(t.geoData){l='<div class="accordion-group" id="accordion-search-result">';l+='<div class="accordion-heading">';l+="<a id=bbox-handle"+t.pkg_id+' class="toggle-layer-extent extent-absent" value="'+e.geoString+'" href="javascript:void(0)" onclick="ngds.Map.addBbox(this)">Show Area on Map</a>';l+="</div></div>";return l}}).join(""),r=_.map(e.resources,function(t){var n=function(e){if("layer_name"in e&&e.layer_name.length>0&&typeof e.layer_name=="string")return e.layer_name;if("layer"in e&&e.layer.length>0&&typeof e.layer=="string")return e.layer;if(e.name){var t=e.name.replace(/\s*-\s*/g," ");return t.replace(/\b./g,function(e){return e.toUpperCase()})}return"Undefined Layer"};t.smartLayer=n(t);if(t.protocol==="OGC:WMS"){l='<div class="accordion-group" id="accordion-search-result">';l+='<div class="accordion-heading">';l+='<a id="'+e.pkg_id+'" class="toggle-layer-wms wms-absent" value="'+t.smartLayer+'" href="javascript:void(0)" onclick="ngds.Map.addWmsLayer(this)">Show Web Map Service</a>';l+="</div></div>";return l}}).join(""),i=_.map(t,function(e){var t="/dataset/"+e.name;l='<div class="accordion-group" id="accordion-search-result">';l+='<div class="accordion-heading">';l+='<a class="data-details-link" target="_blank" href="'+t+'">Go To Dataset Details Page</a>';l+="</div></div>";return l}).join(","),s=_.map(e.resources,function(e){var t=e.content_model_version,n=e.content_model_uri;if(n||t){var r=function(e){if(t&&n||t&&!n)return'<a class="data-uri-link" href="'+t+'">Go To Content Model URI</a>';if(n&&!t)return'<a class="data-uri-link" href="'+n+'">Go To Content Model URI</a>'};e.smartUri=r(e)}if(e.protocol&&e.protocol.search("OGC")!=-1&&e.url){var i=function(e){return e.url.search("getcapabilities")!=-1||e.url.search("GetCapabilities")!=-1||e.url.search("getCapabilities")!=-1||e.url.search("Getcapabilities")!=-1?e.url:e.url+"request=GetCapabilities&service=WMS"};e.smartRequest=i(e)}if(e.protocol==="OGC:WMS"||e.format==="wms"){l='<div class="accordion-group" id="accordion-search-result">';l+='<div class="accordion-heading">';l+='<a class="data-ogc" target="_blank" href="'+e.smartRequest+'">Web Map Service Capabilities</a>';l+="</div></div>";return l}if(e.protocol==="OGC:WFS"||e.format==="wfs"){l='<div class="accordion-group" id="accordion-search-result">';l+='<div class="accordion-heading">';l+='<a class="data-ogc" target="_blank" href="'+e.smartRequest+'">Web Feature Service Capabilities</a>';l+="</div></div>";return l}if(e.protocol==="OGC:WCS"||e.format==="wcs"){l='<div class="accordion-group" id="accordion-search-result">';l+='<div class="accordion-heading">';l+='<a class="data-ogc" target="_blank" href="'+e.url+'">Web Coverage Service Capabilities</a>';l+="</div></div>";return l}if(e.format==="CSV"){l='<div class="accordion-group" id="accordion-search-result">';l+='<div class="accordion-heading">';l+='<a class="data-ogc" href="'+e.url+'">Download CSV Resource</a>';l+="</div></div>";return l}if(e.format==="PDF"){l='<div class="accordion-group" id="accordion-search-result">';l+='<div class="accordion-heading">';l+='<a class="data-ogc" href="'+e.url+'">Download PDF Resource</a>';l+="</div></div>";return l}if(e.format==="ZIP"){l='<div class="accordion-group" id="accordion-search-result">';l+='<div class="accordion-heading">';l+='<a class="data-ogc" href="'+e.url+'">Download Zipfile Resource</a>';l+="</div></div>";return l}if(e.format.indexOf("ms-excel")!==-1){l='<div class="accordion-group" id="accordion-search-result">';l+='<div class="accordion-heading">';l+='<a class="data-ogc" href="'+e.url+'">Download Microsoft Excel Resource</a>';l+="</div></div>";return l}if(e.format.indexOf("openxml")!==-1){l='<div class="accordion-group" id="accordion-search-result">';l+='<div class="accordion-heading">';l+='<a class="data-ogc" href="'+e.url+'">Download Open XML Resource</a>';l+="</div></div>";return l}if(!e.format&&e.url.indexOf("notifications.usgin.org")!==-1){l='<div class="accordion-group" id="accordion-search-result">';l+='<div class="accordion-heading">';l+='<a class="data-ogc" target="_blank" href="'+e.url+'">Service Notifications</a>';l+="</div></div>";return l}if(e.format==="HTML"&&e.url){l='<div class="accordion-group" id="accordion-search-result">';l+='<div class="accordion-heading">';l+='<a class="data-ogc" target="_blank" href="'+e.url+'">External Website</a>';l+="</div></div>";return l}if(!e.format&&e.url){l='<div class="accordion-group" id="accordion-search-result">';l+='<div class="accordion-heading">';l+='<a class="data-ogc" target="_blank" href="'+e.url+'">External Website</a>';l+="</div></div>";return l}}).join(""),o=function(e){return e.length>200?{preview:e.substr(0,200)+"...",full:e}:e.length<=200?e:""},u=function(e){if(e.length>0)return e;l='<div class="accordion-group" id="accordion-search-result">';l+='<div id="no-results" class="accordion-heading">';l+='<div class="data-no-results">This package doesn\'t have any resources</div>';l+="</div></div>";return l},a=e.geojson.properties.feature_id,f=o(e.notes),l='<li class="map-search-result result-'+a+'" >';l+='<div class="accordion" id="accordion-search">';l+='<div class="accordion-group">';l+='<div class="accordion-heading">';l+="<table>";l+='<a class="accordion-toggle feature-id-'+a+'" data-toggle="collapse" data-parent="#accordion-search" href=#collapse'+a+">"+e.title+"</td>";l+="</td></tr></table>";l+='<div class="package-description"><p>'+f.preview+"</p></div></div>";l+="<div id=collapse"+a+' class="accordion-body collapse">';l+='<div class="resource-content">'+n+"</div>";l+='<div class="resource-content">'+r+"</div>";l+='<div class="resource-content">'+i+"</div>";l+='<div class="resource-content">Available Resources'+u(s)+"</div>";l+="</div></div></div></li>";$("#query-results #search-results").append(l);var c={radius:8,fillColor:"#ff5500",color:"#b23b00",weight:2,opacity:1,fillOpacity:.5},h={radius:8,fillColor:"#00aaff",color:"#0076b2",weight:2,opacity:1,fillOpacity:1},p=L.geoJson(e.geojson,{pointToLayer:function(e,t){return L.circleMarker(t,c)},onEachFeature:function(e,t){var n=t.feature.properties.feature_id,r=t.feature.properties.title,i=L.popup().setLatLng(e).setContent(r),s=$(".map-search-result.result-"+n);t.bindPopup(i);t.on("click",function(){var e=$("#collapse"+n),t=$(".feature-id-"+n),r=$("#query-results #search-results li").first();r.hasClass("map-active")&&r.removeClass("map-active");$("#query-results #search-results").prepend(s);$("#query-results #search-results").animate({scrollTop:0},"fast");if(t.hasClass("collapsed")){e.addClass("in");t.removeClass("collapsed");s.addClass("map-active")}else if(e.hasClass("in")){e.removeClass("in");t.addClass("collapsed");s.addClass("map-active")}else{e.addClass("in");s.addClass("map-active")}}),t.on("mouseover",function(){t.setStyle(h);var e=$(".result-"+n);e.addClass("result-highlight")}),t.on("mouseout",function(){t.setStyle(c);var e=$(".result-"+n);e.removeClass("result-highlight")});s.hover(function(){$(s).addClass("result-highlight");t.setStyle(h)},function(){$(s).removeClass("result-highlight");t.setStyle(c)})}});ngds.Map.layers.searchResultsGroup["Search Results"].addLayer(p).addTo(ngds.Map.map)};ngds.Map.map.on("draw:created",function(e){var t=e.layer,n=t.getBounds().toBBoxString(),r={ext_bbox:n};ngds.Map.searchParameters.extras=r;ngds.Map.topLevelSearch(ngds.Map.searchParameters);ngds.Map.map.fitBounds(t.getBounds())});ngds.Map.doPagination=function(e){var t=e.getAttribute("value"),n=parseInt(t.split("-")[0]),r=parseInt(t.split("-")[1]),i=parseInt(t.split("-")[2]),s=ngds.Map.searchParameters,o=$("#load-results-"+n),u='<div class="showing-results">Results '+(i*(n-1)+1)+" - "+r+"</div>";s.page=n;ngds.Map.makeSearch(s);o.empty().append(u)};ngds.Map.addWmsLayer=function(e){var t=$("#"+e.getAttribute("id")),r=t[0].id,i=e.getAttribute("value");if(t.hasClass("wms-absent")){ngds.ckanlib.get_wms_urls(r,function(e){_.each(e,function(e){var t={layers:e.layer,format:e.format,transparent:!0,version:"1.1.1"},s=[[e.bbox[1],e.bbox[0]],[e.bbox[3],e.bbox[2]]],o=L.tileLayer.wms(e.service_url,t);ngds.Map.layers.wmsLayersGroup[r]=o;var u=ngds.Map.layers.wmsLayersGroup[r];n.addOverlay(u,i);ngds.Map.map.addLayer(u);ngds.Map.map.fitBounds(s)})});t.removeClass("wms-absent").addClass("wms-present");t.text("Hide Web Map Service")}else if(t.hasClass("wms-present")){var s=ngds.Map.layers.wmsLayersGroup[r];ngds.Map.map.removeLayer(s);n.removeLayer(s);t.removeClass("wms-present").addClass("wms-absent");t.text("Show Web Map Service")}};ngds.Map.addBbox=function(e){var t=$("#"+e.getAttribute("id")),n=t[0].id.split("bbox-handle")[1];if(t.hasClass("extent-absent")){var r=e.getAttribute("value").split(","),i=[];_.each(r,function(e){var t=parseFloat(e);i.push(t)});var s=[[i[0],i[1]],[i[2],i[3]]],o=L.rectangle(s,{color:"red",opacity:1,fillOpacity:.2,weight:1});bboxGroup=ngds.Map.layers.dataExtentsGroup;bboxGroup["Data Extents"][n]=o;bboxGroup["Data Extents"][n].addTo(ngds.Map.map).bringToBack();ngds.Map.map.fitBounds(bboxGroup["Data Extents"][n],{maxZoom:6,padding:[200,200]});t.removeClass("extent-absent").addClass("extent-present");t.text("Hide Area on Map")}else if(t.hasClass("extent-present")){var u=bboxGroup["Data Extents"][n];ngds.Map.map.removeLayer(u);t.removeClass("extent-present").addClass("extent-absent");t.text("Show Area on Map")}};ngds.Map.toggleContentMenu=function(){if($("#content-legend-menu").hasClass("shown")){$("#content-legend-menu").removeClass("shown");$("#line-triangle").removeClass("left-triangle");$("#line-triangle").addClass("right-triangle")}else{$("#content-legend-menu").addClass("shown");$("#line-triangle").removeClass("right-triangle");$("#line-triangle").addClass("left-triangle")}};var t=ngds.Map.layers.searchResultsGroup,n=L.control.layers(null,t,{position:"topleft"});e.addTo(ngds.Map.map);ngds.Map.layers.baseLayer.addTo(ngds.Map.map);ngds.Map.map.addControl(ngds.Map.controls.doodle);ngds.Map.map.addControl(new ngds.Map.controls.reset);n.addTo(ngds.Map.map);ngds.Map.map.addControl(ngds.Map.controls.loading);$(".leaflet-draw-toolbar-top").removeClass("leaflet-draw-toolbar");$(".leaflet-draw-draw-rectangle").addClass("glyphicon icon-pencil")}).call(this);