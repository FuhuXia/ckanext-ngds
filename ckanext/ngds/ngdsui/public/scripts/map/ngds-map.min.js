/* Copyright (c) 2014, Siemens Coporate Technology and Arizona Geological Survey */
(function(){var a=new L.FeatureGroup();ngds.Map={map:L.map("map-container",{center:[39.977,-97.646],zoom:4,maxBounds:[[-84,-179],[84,179]],attributionControl:true,minZoom:2}),layers:{baseLayer:L.tileLayer("http://otile{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpeg",{subdomains:"1234",attribution:'Tiles Courtesy of <a href="http://www.mapquest.com/">MapQuest</a> &mdash; Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',detectRetina:true}),searchResultsGroup:L.layerGroup()},controls:{loading:L.Control.loading({separate:true,position:"topleft"}),doodle:new L.Control.Draw({position:"topleft",draw:{polyline:false,circle:false,marker:false,polygon:false},edit:{featureGroup:a,remove:false,edit:false}}),search:L.Control.extend({options:{position:"topleft"},onAdd:function(){var b=L.DomUtil.create("div","ngds-custom-control search-control");L.DomEvent.on(b,"click",L.DomEvent.stopPropagation).on(b,"dblclick",L.DomEvent.stopPropagation).on(b,"mousedown",L.DomEvent.stopPropagation).addListener(b,"click",function(){var c=ngds.Map.layers.searchResultsGroup;if($(b).hasClass("off")){$(b).removeClass("off");$(b).addClass("on");ngds.Map.map.addLayer(c)}else{if($(b).hasClass("on")){$(b).removeClass("on");$(b).addClass("off");ngds.Map.map.removeLayer(c)}else{$(b).addClass("off");ngds.Map.map.removeLayer(c)}}});$(b).append('<a class="glyphicon icon-search" href="#" title="Toggle search results"></a>');return b}}),reset:L.Control.extend({options:{position:"topleft"},onAdd:function(){var b=L.DomUtil.create("div","ngds-custom-control reset-control");L.DomEvent.on(b,"click",L.DomEvent.stopPropagation).on(b,"dblclick",L.DomEvent.stopPropagation).on(b,"mousedown",L.DomEvent.stopPropagation).addListener(b,"click",function(){ngds.Map.map.setView([39.977,-97.46],4)});$(b).append('<a class="glyphicon icon-home" href="#" title="Reset extent"></a>');return b}})}};ngds.Map.topLevelSearch=function(e){var b=ngds.Map.layers.searchResultsGroup;if(b.getLayers().length>1){b.clearLayers()}$("#query-results").empty();var c=e||{"ext:bbox":"-180,-90,180,90"},d=$("#map-search-query").val();ngds.Map.makeSearch({q:d,extras:c});$("#content-legend-menu").addClass("shown")};ngds.Map.makeSearch=function(c){var g=ngds.ckanlib.package_search,f=10,e=1,h=(e-1)*f,d=c.q,b=c.extras;g({q:d,rows:f,start:h,extras:b},function(i){_.each(i.result.results,function(q){if(q.extras.length>11){var o=Math.floor(Math.random()*1e+21),p=JSON.parse(q.extras[22].value),m={sw_lat:p.coordinates[0][0][1],sw_lon:p.coordinates[0][0][0],ne_lat:p.coordinates[0][2][1],ne_lon:p.coordinates[0][2][0]},n=L.latLngBounds([[m.sw_lon,m.sw_lat],[m.ne_lon,m.ne_lat]]),j=n.getCenter(),l={type:"Feature",properties:{feature_id:o},geometry:{type:"Point",coordinates:[j.lat,j.lng]}},k={title:q.title,name:q.name,notes:q.notes,pkg_id:q.id,resources:q.resources,geoData:m,geojson:l};ngds.Map.returnSearchResult(k)}else{var o=Math.floor(Math.random()*1e+21),p=JSON.parse(q.extras[8].value),m={sw_lat:p.coordinates[0][0][1],sw_lon:p.coordinates[0][0][0],ne_lat:p.coordinates[0][2][1],ne_lon:p.coordinates[0][2][0]},n=L.latLngBounds([[m.sw_lon,m.sw_lat],[m.ne_lon,m.ne_lat]]),j=n.getCenter(),l={type:"Feature",properties:{feature_id:o},geometry:{type:"Point",coordinates:[j.lat,j.lng]}},k={title:q.title,name:q.name,notes:q.notes,pkg_id:q.id,resources:q.resources,geoData:m,geojson:l};ngds.Map.returnSearchResult(k)}})})};ngds.Map.returnSearchResult=function(b){var e=_.map(b.resources,function(h){if(h.format){d='<div class="accordion-group" id="accordion-search-result">';d+='<div class="accordion-heading">';d+='<table><tr><td><span class="label label-success">'+h.format+"</span></td><td>";d+='<a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion-search-result" href=#collapse'+h.id+">"+h.name+"</a></div>";d+="</td></tr></table>";d+="<div id=collapse"+h.id+' class="accordion-body collapse">';d+="<p>"+h.description+"</p>";d+="</div></div></div>";return d}else{if(h.protocol==="OGC:WMS"){d='<div class="accordion-group" id="accordion-search-result">';d+='<div class="accordion-heading">';d+='<table><tr><td><span class="label label-success">'+h.protocol+"</span></td><td>";d+='<a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion-search-result" href=#collapse'+h.id+">"+h.layer+"</a></div>";d+="</td></tr></table>";d+="<div id=collapse"+h.id+' class="accordion-body collapse">';d+="<p>"+h.description+"</p>";d+='<table><tr><td><div class="glyphicon icon-globe"</td>';d+='<td><a id="'+b.pkg_id+'" class="wms-handle" href="javascript:void(0)" onclick="ngds.Map.addWmsLayer(this.id)">WMS Layer</a></td>';d+="</tr></table></div></div></div>";return d}else{if(h.protocol){d='<div class="accordion-group" id="accordion-search-result">';d+='<div class="accordion-heading">';d+='<table><tr><td><span class="label label-success">'+h.protocol+"</span></td><td>";d+='<a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion-search-result" href=#collapse'+h.id+">"+h.layer+"</a></div>";d+="</td></tr></table>";d+="<div id=collapse"+h.id+' class="accordion-body collapse">';d+="<p>"+h.description+"</p>";d+="</div></div></div>";return d}}}}).join("");var c=b.geojson.properties.feature_id,d='<li class="map-search-result result-'+c+'" >';d+='<div class="accordion" id="accordion-search">';d+='<div class="accordion-group">';d+='<div class="accordion-heading">';d+='<table><tr><td><span class="glyphicon icon-plus-sign"></span></td><td>';d+='<a class="accordion-toggle feature-id-'+c+'" data-toggle="collapse" data-parent="#accordion-search" href=#collapse'+c+">"+b.title+"</a></td>";d+="</td></tr></table></div>";d+="<div id=collapse"+c+' class="accordion-body collapse">';d+='<div class="resource-content">'+e+"</div>";d+="</div></div></div></li>";$("#query-results").append(d);var g={radius:8,fillColor:"#ff0000",color:"#ff0000",weight:2,opacity:1,fillOpacity:0.5};var f=L.geoJson(b.geojson,{pointToLayer:function(h,i){return L.circleMarker(i,g)},onEachFeature:function(k,j){var i=j.feature.properties.feature_id;j.on("click",function(){var m=$("#collapse"+i),l=$(".feature-id-"+i);if(l.hasClass("collapsed")){m.addClass("in");l.removeClass("collapsed")}else{if(m.hasClass("in")){m.removeClass("in");l.addClass("collapsed")}else{m.addClass("in")}}}),j.on("mouseover",function(){j.setStyle({fillColor:"yellow"});var l=$(".result-"+i);l.addClass("result-highlight")}),j.on("mouseout",function(){j.setStyle(g);var l=$(".result-"+i);l.removeClass("result-highlight")});var h=$(".map-search-result.result-"+i);h.hover(function(){$(h).addClass("result-highlight");j.setStyle({fillColor:"yellow"})},function(){$(h).removeClass("result-highlight");j.setStyle(g)})}});ngds.Map.layers.searchResultsGroup.addLayer(f).addTo(ngds.Map.map)};ngds.Map.map.on("draw:created",function(d){var b=d.layer,f=b.getBounds().toBBoxString(),c={ext_bbox:f};ngds.Map.topLevelSearch(c);ngds.Map.map.fitBounds(b.getBounds())});ngds.Map.addWmsLayer=function(b){ngds.ckanlib.get_wms_urls(b,function(c){_.each(c,function(d){var g={layers:d.layer,format:d.format,transparent:true,version:"1.1.1"},f=[[d.bbox[1],d.bbox[0]],[d.bbox[3],d.bbox[2]]],e=L.tileLayer.wms(d.service_url,g);ngds.Map.map.addLayer(e);ngds.Map.map.fitBounds(f)})})};ngds.Map.toggleContentMenu=function(){if($("#content-legend-menu").hasClass("shown")){$("#content-legend-menu").removeClass("shown");$("#line-triangle").removeClass("left-triangle");$("#line-triangle").addClass("right-triangle")}else{$("#content-legend-menu").addClass("shown");$("#line-triangle").removeClass("right-triangle");$("#line-triangle").addClass("left-triangle")}};a.addTo(ngds.Map.map);ngds.Map.layers.baseLayer.addTo(ngds.Map.map);ngds.Map.map.addControl(ngds.Map.controls.doodle);ngds.Map.map.addControl(new ngds.Map.controls.search);ngds.Map.map.addControl(new ngds.Map.controls.reset);ngds.Map.map.addControl(ngds.Map.controls.loading);$(".leaflet-draw-toolbar-top").removeClass("leaflet-draw-toolbar");$(".leaflet-draw-draw-rectangle").addClass("glyphicon icon-pencil")}).call(this);
