/*
 *	@author - Vivek
 *	@revised by Adrian 7/2013
 *	This object exposes an API to interact with the NGDS map.
 *
 */ngds.Map={initialize:function(){var e="https://eia-ms.esri.com/arcgis/rest/services/20130301StateEnergyProfilesMap/MapServer/export",t="https://eia-ms.esri.com/arcgis/rest/services/20130301StateEnergyProfilesMap/MapServer/export",n="https://eia-ms.esri.com/arcgis/rest/services/20130301StateEnergyProfilesMap/MapServer/export",r="https://eia-ms.esri.com/arcgis/rest/services/20130301StateEnergyProfilesMap/MapServer/export",i="https://gis.srh.noaa.gov/ArcGIS/rest/services/RIDGERadar/MapServer/export",s="http://services.arcgisonline.com/ArcGIS/rest/services/Specialty/Soil_Survey_Map/MapServer/",o="http://basemap.nationalmap.gov/ArcGIS/rest/services/USGSTopo/MapServer/",u=new L.TileLayer("http://{s}.maptile.maps.svc.ovi.com/maptiler/v2/maptile/newest/terrain.day/{z}/{x}/{y}/256/png8",{attribution:"Map &copy; <a href='http://developer.here.com'>Nokia</a>, Data &copy; NAVTEQ 2012"}),a=this.map=new L.Map("map-container",{layers:[u],center:new L.LatLng(34.1618,-100.53332),zoom:3,zoomControl:!1}),f=L.Control.loading({separate:!0,position:"topleft"}),l=new L.TileLayer.EsriImageExports(e,{layers:"42"}),c=new L.TileLayer.EsriImageExports(t,{layers:"36"}),h=new L.TileLayer.EsriImageExports(n,{layers:"1"}),p=new L.TileLayer.EsriImageExports(r,{layers:["21,22,26"]}),d=new L.TileLayer.EsriImageExports(i,{layers:"0"}),v=new L.tileLayer.wms("http://geo.cei.psu.edu:8080/geoserver/wms",{format:"image/png",transparent:!0,attribution:"US Soil Survey",layers:"cei:canada,cei:mexicarib,cei:mlra_48,cei:lower48",styles:"other_polygons,other_polygons,llrShadeTest_opaque,state_noFill",srs:"srs:EPSG:102003"}),m=L.tileLayer.wms("http://geothermal.smu.edu/geoserver/wms",{layers:"wells",format:"image/png",transparent:!0,attribution:"SMU Well Data"}),g=L.tileLayer.wms("http://www.geocommunicator.gov/arcgis/services/Basemaps/MapServer/WMSServer",{layers:"0,1,3,4,5,6,7,8,9,10,11,12,13,14,15",format:"image/png",transparent:!0}),y=new L.TileLayer("http://basemap.nationalmap.gov/ArcGIS/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}"),b=this.geoJSONLayer=new L.geoJson(null,{onEachFeature:function(e,t){}}),w=new L.Control.Draw({position:"topleft",polyline:!1,circle:!1,marker:!1,polygon:!1});a.addControl(w);var E=ngds.Map.drawnItems=new L.LayerGroup;a.addLayer(E);var S=ngds.Map.geosearch=new L.Control.GeoSearch({provider:new L.GeoSearch.Provider.OpenStreetMap,position:"topright",searchLabel:"Locate an address"});S.addTo(a);var x=new ngds.Zoom({position:"topright"}),T=new L.Clear;a.addControl(T);var N=new L.FullScreen;a.addControl(x);N.is_fs_supported()===!0&&a.addControl(N);a.addControl(f);this.layers={geojson:b,drawnItems:E,soil:v,land:g,topography:y,nerc:l,geothermal_potential:c,counties:h,weather:d};var C={Terrain:u,"US Topographic Map":y,"Soil Extent Map":v};overlayMaps={"Search Results":b,"SMU Wells":m,"USBLM Urban Areas, Counties":g,"NERC Regions":l,"Geothermal Potential":c,"US County Boundaries":h,"NEXRAD Weather":d};layer_control=new L.control.layers(C,overlayMaps,{autoZIndex:!0});layer_control.addTo(a);a.on("layeradd",function(e){try{b.bringToFront()}catch(t){}});copy=[];a.addLayer(b);var k=L.Icon.Label.extend({options:{iconUrl:"",shadowUrl:null,iconSize:new L.Point(36,36),iconAnchor:new L.Point(0,1),labelAnchor:new L.Point(0,0),wrapperAnchor:new L.Point(0,13),labelClassName:"placeMarks-label"}}),A=L.Icon.Label.extend({options:{iconUrl:"",shadowUrl:null,iconSize:new L.Point(36,36),iconAnchor:new L.Point(0,1),labelAnchor:new L.Point(5,5),wrapperAnchor:new L.Point(12,13),labelClassName:"placeMarks-label"}});placeMarker_triple=L.Icon.Label.extend({options:{iconUrl:"",shadowUrl:null,iconSize:new L.Point(25,41),iconAnchor:new L.Point(0,0),labelAnchor:new L.Point(0,0),wrapperAnchor:new L.Point(13,41),labelClassName:"placeMarks-label",popupAnchor:new L.Point(0,-33)}});ngds.publish("Map.loaded",{})},initialize_controls:function(){var e="";e+='<div id="map-expander">';e+="<p>&lt;&lt;</p>";e+="</div>";var t=!1,n=$("#map-container").css("width"),r="<p>&lt;&lt;</p>",i="<p>&gt;&gt;</p>";$("#map-container").append(e);$("#map-expander").click(function(){if(t===!1){t=!0;$(".map-search").hide();$("#map-container").css("width",1024);$("#map-expander").empty();$("#map-expander").append(i);ngds.Map.map.invalidateSize()}else{t=!1;$("#map-container").css("width",n);ngds.Map.map.invalidateSize();$(".map-search").show();$("#map-expander").empty();$("#map-expander").append(r)}return!1})},zoom_managed_list:{},zoom_listeners:[],map_search:function(){var e=this;geoj=e.get_layer("drawnItems");var t=$("#map-query").val(),n=ngds.Pager(5);n.set_action(ngds.ckanlib.package_search,{q:t});ngds.Map.shape.str=="rect";e.clear_layer("geojson");n.move(1,function(e,t){var n=ngds.Map.labeller.get_cur_label();ngds.Map.add_raw_result_to_geojson_layer(e,{iconimg_id:"lmarker-"+n});var r="0px";if(t==="marker"){$(".result-"+n).hover(function(){$(".lmarker-"+n).css("width","30px");$(".lmarker-"+n).css("height","45px");var e=$(".lmarker-"+n).next();e.css("font-size","14pt");e.css("margin-left","2px")},function(){$(".lmarker-"+n).css("width","25px");$(".lmarker-"+n).css("height","41px");var e=$(".lmarker-"+n).next();e.css("font-size","12.5pt");e.css("margin-left",r)});$(".result-"+n).click(function(){$(".result").css("background-color","#fff");var e=ngds.Map.state.colored_labels||(ngds.Map.state.colored_labels=[]);for(var t=0;t<e.length;t++)e[t].attr("src","/images/marker.png");for(var r in ngds.Map.state.shapes_map)ngds.Map.state.shapes_map[r]!==null&&typeof ngds.Map.state.shapes_map[r]!="undefined"&&ngds.Map.state.shapes_map[r].setStyle({weight:ngds.Map.state.shapes_map[r].orig_weight,color:ngds.Map.state.shapes_map[r].orig_color});e=ngds.Map.state.colored_labels=[];$(".result-"+n).css("background-color","#dadada");$(".lmarker-"+n).attr("src","/images/marker-red.png");e.push($(".lmarker-"+n))})}else{$(".result-"+n).hover(function(){var e=ngds.Map.state.shapes_map[n];ngds.Map.state.shapes_map[n].prev_weight=ngds.Map.state.shapes_map[n].options.weight;ngds.Map.state.shapes_map[n].prev_color=ngds.Map.state.shapes_map[n].options.color;e.setStyle({weight:2,color:"#d54799"})},function(){var e=ngds.Map.state.shapes_map[n];e.setStyle({weight:ngds.Map.state.shapes_map[n].prev_weight,color:ngds.Map.state.shapes_map[n].prev_color})});$(".result-"+n).click(function(){$(".result").css("background-color","#fff");var e=ngds.Map.state.colored_labels||(ngds.Map.state.colored_labels=[]);for(var t=0;t<e.length;t++)e[t].attr("src","/images/marker.png");for(var r in ngds.Map.state.shapes_map)ngds.Map.state.shapes_map[r]!==null&&typeof ngds.Map.state.shapes_map[r]!="undefined"&&r!==n&&ngds.Map.state.shapes_map[r].setStyle({weight:ngds.Map.state.shapes_map[r].orig_weight,color:ngds.Map.state.shapes_map[r].orig_color});$(".result-"+n).css("background-color","#dadada");var i=ngds.Map.state.shapes_map[n];if(i!==null&&typeof i!="undefined"){i.setStyle({weight:3,color:"red"});ngds.Map.state.shapes_map[n].prev_weight=3;ngds.Map.state.shapes_map[n].prev_color="red"}})}},function(e){n.set_state(e,t)})},get_layer:function(e){if(e in this.layers)return this.layers[e];throw"No layer exists with the key : "+e},add_to_layer:function(e,t){var n=this;t in this.layers&&e.length>0&&$.each(e,function(e,r){r.addTo(n.layers[t])})},clear_layer:function(e){this.layers[e].clearLayers()},add_packages_to_geojson_layer:function(e){var t=this;$.each(e,function(e,n){ngds.ckanlib.package_show(n,function(e){t.add_raw_result_to_geojson_layer(e.result)})})},add_raw_result_to_geojson_layer:function(e,t){try{var n=ngds.ckandataset(e),r=n.getGeoJSON(),i=n.map.getPopupHTML()}catch(s){return}var o=L.geoJson(r,{style:{color:"black",weight:1,opacity:1,fillColor:"grey",fillOpacity:.2},onEachFeature:function(e,n){var r=function(e){return e.feature.type=="Point"?"Marker":"Feature"}(n);ngds.Map.add_to_layer([n],"geojson");ngds.publish("Map.add_feature",{feature:n,seq_id:t.seq,type:r});if(n.feature.geometry.type==="Polygon"){ngds.Map.zoom_handler(n);var i=t.seq,s=ngds.Map.state.shapes_map||(ngds.Map.state.shapes_map={});s[i]=n;s[i].orig_color="blue";s[i].orig_weight=2}},pointToLayer:function(e,n){var r=L.marker(n,{icon:new placeMarker_triple({iconUrl:"/images/marker.png",labelText:t.alph_seq,className:"lmarker-"+t.seq})});return r}});o.bindPopup(i);this.add_to_layer([o],"geojson");this.sort_geojson_layers(o);return o},sort_geojson_layers:function(e){var t=(new ngds.Map.BoundingBox).store_raw(e.getBounds()).get_perimeter();typeof ngds.util.state["map_features"]=="undefined"&&(ngds.util.state.map_features=[]);var n=ngds.util.state.map_features,r=0;for(r=0;r<=n.length;r++){if(r===n.length)break;if(typeof n[r]=="undefined"||n[r]===null)continue;if(t<(new ngds.Map.BoundingBox).store_raw(n[r].getBounds()).get_perimeter())break}n.splice(r,0,e);for(var r=n.length-1;r>-1;r--){if(typeof n[r]=="undefined"||n[r]===null)continue;n[r].bringToFront()}},utils:{get_bound:function(coords,lat_or_lng,min_or_max){(function(){if(lat_or_lng!=="lat"&&lat_or_lng!=="lng"||min_or_max!=="min"&&min_or_max!=="max")throw"Expected 'lat' or 'lng' for lat_or_lng and 'min' or 'max' for min_or_max"})();var func=eval("Math."+min_or_max),operands=[];$.each(coords,function(e,t){operands.push(t[lat_or_lng])});return func.apply(this,operands)}},register_map_query_provider:function(e){(function(){if(e===null||typeof e=="undefined")throw"Expected a string for id_provider."})();this.query_provider="#"+e},state:{},is_fullscreen:function(){return typeof ngds.Map.state["fullscreen"]=="undefined"?!1:ngds.Map.state.fullscreen}};