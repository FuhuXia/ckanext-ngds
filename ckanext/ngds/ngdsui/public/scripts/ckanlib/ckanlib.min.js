/*
 *	@author - Vivek
 *	A set of functions to make ajax calls to the CKAN API.
 */ngds.ckanlib={dataset_geo:function(e,t){var n="/api/2/search/dataset/geo?bbox=";if(!typeof e==="object")throw"Parameter bbox : Expected a BoundingBox Object.";$.each(e.get_bbox_array(),function(e,t){(function(e){if(e===null||typeof e=="undefined")throw"Missing parameter : Expected minx,miny,maxx,maxy."})(t)});(function(){if(typeof t!="function")throw"Missing parameter : Expected callback function."})();var r=n+e.get_bbox_array().join(",");$.ajax({url:r,type:"GET",dataType:"JSON",success:function(e){return t(e)}})},dataset_poly_geo:function(e,t){(function(){if(e===null||typeof e=="undefined")throw"Missing parameter : Expected an array of coordinates representing a polygon.";if(typeof t!="function")throw"Missing parameter : Expected callback function."})();if(e.length===0)return;var n="/poly",r={data:JSON.stringify({poly:e})},i="POST";$.ajax({url:n,data:r,success:function(e){return t(e)}})},package_show:function(e,t){(function(){if(e===null||typeof e=="undefined")throw"Missing parameter : Expected package_id.";if(typeof t!="function")throw"Missing parameter : Expected callback function."})();var n="/api/action/package_show",r=JSON.stringify({id:e});$.ajax({url:n,type:"POST",dataType:"JSON",data:r,success:function(e){return t(e)}})},package_search:function(e,t){(function(){if(e!==null&&typeof e!="undefined"&&typeof e=="undefined")throw"Expected an object as the second parameter.";if(typeof t!="function")throw"Expected a callback function."})();var n=null,r=!1,i=e.q.split(" ");for(var s=0;s<i.length;s++){var o=i[s].replace(" ","").replace(" ","");if(o==="near"||o==="in"){r=!0;break}}if(r===!0){n=i.splice(s+1,i.length);var u=i.splice(0,s).join(" ");e.q=u;var a=new L.GeoSearch.Provider.OpenStreetMap,f=a.GetServiceUrl(n);ngds.publish("data-loading",{});$.getJSON(f,function(n){var r=ngds.ckanlib.transform_neg,i=ngds.ckanlib.transform_pos,s=Math.min(r(n[0].boundingbox[0]),i(n[0].boundingbox[1])),o=Math.max(r(n[0].boundingbox[0]),i(n[0].boundingbox[1])),u=Math.min(r(n[0].boundingbox[2]),i(n[0].boundingbox[3])),a=Math.max(r(n[0].boundingbox[2]),i(n[0].boundingbox[3])),f=u+","+s+","+a+","+o;(new L.rectangle([[s,u],[o,a]],{color:"green",dashArray:"5,5",weight:"3",opacity:1,fillOpacity:0})).addTo(ngds.Map.geoJSONLayer);e.extras.ext_bbox=f;ngds.ckanlib.package_search(e,function(e){ngds.publish("data-loaded",{});return t(e)})});return}ngds.publish("data-loading",{});var l="/api/action/package_search",c="POST",h={sort:""};for(key in e)e[key]!==null&&typeof e[key]!="undefined"&&(h[key]=e[key]);$.ajax({url:l,type:c,dataType:"JSON",data:JSON.stringify(h),success:function(e){ngds.publish("data-loaded",{});return t(e)}})},transform_neg:function(e){var t=Number(e),n=0;t<0?n=-(Math.abs(t)+2):n=t-2;return n},transform_pos:function(e){var t=Number(e),n=0;t<0?n=-(Math.abs(t)-2):n=t+2;return n},get_responsible_party:function(e,t){(function(){if(e===null||typeof e=="undefined")throw"Expected valid id";if(typeof t!="function")throw"Expected callback function"})();var n="/api/action/additional_metadata",r="ResponsibleParty",i="read",s={model:r,process:i,data:{id:e}};$.ajax({url:n,data:s,success:function(e){return t(e)}})},datastore_search:function(e,t){if(typeof e=="undefined"||e===null)throw"Expected resource id. Got nothing.";if(typeof t!="function"||t===null)throw"Expected callback function. Got nothing.";$.ajax({url:"/api/3/action/datastore_search",data:{resource_id:e},dataType:"jsonp",success:function(e){return t(e)}})},publish_to_geoserver:function(e){$.ajax({url:"/api/action/geoserver_publish_layer",type:"POST",data:JSON.stringify({gs_lyr_name:e.layer_name,resource_id:e.resource_id,package_id:e.package_id,col_geography:e.col_geo,col_latitude:e.col_lat,col_longitude:e.col_lng}),success:function(t){e.callback({response:t,status:"success"})},error:function(){e.callback({status:"failure"})}})},unpublish_layer:function(e){$.ajax({url:"/api/action/geoserver_unpublish_layer",type:"POST",data:JSON.stringify({resource_id:e.resource_id,gs_lyr_name:e.layer_name}),success:function(t){e.callback({response:t,status:"success"})},error:function(){e.callback({status:"failure"})}})},get_wms_urls:function(e,t){$.ajax({url:"/api/action/get_wms",type:"POST",data:JSON.stringify({pkg_id:e}),success:function(e){return t(e.result)},error:function(){}})}};