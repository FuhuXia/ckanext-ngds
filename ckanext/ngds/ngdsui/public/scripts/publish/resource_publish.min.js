/* Copyright (c) 2014, Siemens Corporate Technology and Arizona Geological Survey *//* Copyright (c) 2014, Siemens Corporate Technology and Arizona Geological Survey *//* Copyright (c) 2014, Siemens Corporate Technology and Arizona Geological Survey */$(document).ready(function(){$("button[data-ogc-publish]").click(function(e){var t=$(this).attr("data-ogc-resource"),n=$(this).attr("data-ogc-collection"),r=$(this).attr("data-ogc-layer");r?ngds.publisher.publish_usgin(t,n,r):ngds.publisher.publish_other(t,n)});$("button[data-ogc-unpublish]").click(function(e){var t=$(this).attr("data-ogc-resource"),n=$(this).attr("data-ogc-layer");ngds.publisher.unpublish(t,n)});ngds.publisher={publish_other:function(e,t){var n=['<div class="modal">','<div class="modal-header">','<button type="button" class="close" data-dismiss="modal">Ã—</button>',"<h3>Publish resource to OGC</h3>","</div>",'<div class="modal-body">','<div class="geoserver-layer-modal">','<label>Geoserver Layer Name</label><input type="text" name="geoserver_layer_name" />',"</div>",'<div id="processing">Please wait while we try to fetch field names in this resource ...</div>',"</div>",'<div class="modal-footer">','<button class="btn btn-cancel">Cancel</button>','<button class="btn btn-primary">Confirm</button>',"</div>","</div>"].join("\n"),r=$(n),i=r.modal({show:!0});ngds.ckanlib.datastore_search(e,function(e){var t=$("<select/>",{"class":"geoserver-lat-selector",name:"lat"}),n=$("<select/>",{"class":"geoserver-lng-selector",name:"lng"}),r=function(e){return e.map(function(e){return $("<option/>",{text:e.id,value:e.id})})},i=r(e.result.fields),s=r(e.result.fields);i.map(function(e){t.append(e)});s.map(function(e){n.append(e)});var o=$("<div/>",{}),u=$("<div/>",{}),a=$("<div/>",{}),f=$("<label/>",{text:"Latitude Field"}),l=$("<label/>",{text:"Longitude Field"});o.append(f);o.append(t);u.append(l);u.append(n);a.append(o);a.append(u);$(".modal #processing").replaceWith(a)});r.on("click",".btn-primary",function(n){n.preventDefault();i.modal("hide");ckan.notify("Please wait while this resource is published ...... ","","info");ngds.ckanlib.publish_to_geoserver({action:"/api/action/geoserver_publish_layer",layer_name:$("[name=geoserver_layer_name]").val(),resource_id:e,package_id:t,col_geo:"geometry",col_lat:$("[name=lat]").val(),col_lng:$("[name=lng]").val(),callback:function(e){if(e.status==="failure")ckan.notify("Sorry. The action requested could not be successfully completed.","","error");else{ckan.notify("This resource has now been published as an OGC service.","","success");window.location.reload()}}})});r.on("click",".btn-cancel",function(e){e.preventDefault();i.modal("hide")})},publish_usgin:function(e,t,n){ckan.notify("Publishing tier 3 structured OGC services...","","info");ngds.ckanlib.datastore_search(e,function(r){var i=r.result.fields,s=function(){var e=[];for(var t=0;t<i.length;t++)e.push(i[t].id);return e}(),o=function(){return s.indexOf("LatDegree")!==-1&&s.indexOf("LongDegree")!==-1?o={lat:"LatDegree",lng:"LongDegree"}:o={lat:"LatDegreeWGS84",lng:"LongDegreeWGS84"}}();ngds.ckanlib.publish_to_geoserver({action:"/api/action/geoserver_publish_usgin_layer",layer_name:n,resource_id:e,package_id:t,content_model_layer:n,col_geo:"geometry",col_lat:o.lat,col_lng:o.lng,callback:function(e){e.status==="failure"?ckan.notify("Failed to publish OGC services","","error"):window.location.reload()}})})},unpublish:function(e,t){console.log("Unpublishing "+e+" "+t);ckan.notify("Removing OGC services for this dataset","","info");ngds.ckanlib.unpublish_layer({layer_name:t,resource_id:e,callback:function(e){e.status==="failure"?ckan.notify("Sorry. The action requested could not be successfully completed.","","error"):window.location.reload()}})}}});(function(){var e=$("#prospector-btn").attr("res_url"),t=$("#prospector-btn").attr("res_layer"),n=JSON.stringify({url:e,layer:t});$("#prospector-btn").attr("data-toggle","tooltip");$("#prospector-btn").attr("title","Loading data...");$.ajax({url:"/api/action/geothermal_prospector",type:"POST",data:n,success:function(e){var t=e.result.wms;$("#prospector-btn").attr("href",t);$("#prospector-btn").attr("target","_blank");$("#prospector-btn").removeClass("disabled");$("#prospector-btn").removeAttr("data-toggle");$("#prospector-btn").removeAttr("title")},error:function(){$("#prospector-btn").removeAttr("title");$("#prospector-btn").attr("title","Error loading service")}})}).call(this);