/* Copyright (c) 2014, Siemens Corporate Technology and Arizona Geological Survey *//* Copyright (c) 2014, Siemens Corporate Technology and Arizona Geological Survey *//* Copyright (c) 2014, Siemens Corporate Technology and Arizona Geological Survey */$(document).ready(function(){function t(){if($("#field-authors").data("select2")&&$("#field-authors").data("select2").opts){clearInterval(e);ngds.responsible_parties.overrideInitSelection("#field-authors");$("#field-authors").trigger("change")}}function r(){if($("#field-maintainer").data("select2")&&$("#field-maintainer").data("select2").opts){clearInterval(n);ngds.responsible_parties.overrideInitSelection("#field-maintainer");$("#field-maintainer").trigger("change")}}var e=setInterval(t,10),n=setInterval(r,10);$("#field-authors").on("change",function(e){e.added&&e.added.id==e.added.text&&ngds.responsible_parties.add_new("Add New Author","#field-authors",e.added);if(e.removed){var t=$("#field-authors").select2("data");if(t.length>0){var n=t[0].id;for(var r=1;r<t.length;r++)n+=","+t[r].id;$("#field-authors").val(n)}else $("#field-authors").val("")}var i=$("#field-authors").val();i=i.replace(/\[/g,"").replace(/\]/g,"").replace(/^s+|\s+$/g,"");i[0]==","&&(i=i.substring(1));$("#field-authors").val("["+i+"]")});$("#field-maintainer").on("change",function(e){try{$.parseJSON(e.val)}catch(t){ngds.responsible_parties.add_new("Add New Maintainer","#field-maintainer",e.val)}});ngds.responsible_parties={initSelection:function(e,t){var n=[];try{var r=$.parseJSON(e.val());if(r instanceof Array){$.each(r,function(e,t){n.push({id:JSON.stringify(t),text:t.name})});e.val("");t(n);$(e).data("select2").opts.multiple&&$(e).val()[0]!="["&&$(e).val("["+$(e).val()+"]")}else t({id:JSON.stringify(r),text:r.name})}catch(i){}},overrideInitSelection:function(e){$(e).data("select2").opts.initSelection=ngds.responsible_parties.initSelection;$(e).data("select2").opts.formatSelection=function(e,t){try{var n=JSON.parse(e.id);return"<span title='"+n.name+"\n"+n.email+"'>"+e.text+"</span>"}catch(r){return e.text}}},add_new:function(e,t,n){var r=['<div class="modal" style="top: 10%">','<div class="modal-header">','<button type="button" class="close" data-dismiss="modal">Ã—</button>',"<h3>",e,"</h3>","</div>",'<div class="modal-body">','<div class="add-responsible">','<label id="rs_name_lbl" for="rs_name">Name<sup class="mandatory">*</sup></label><input type="text" id="rs_name" /></div>','<div class="add-responsible" style="margin-top: 0">','<div class="add-err-label"/><div id="rs_name_err" class="missing-field-hide">Missing Field</div></div>','<div class="add-responsible">','<label id="rs_email_lbl" for="rs_email">Email<sup class="mandatory">*</sup></label><input type="email" id="rs_email" /></div>','<div class="add-responsible" style="margin-top: 0">','<div class="add-err-label"/><div id="rs_email_err" class="missing-field-hide">Missing Field</div><div id="rs_email_dup" class="missing-field-hide">Email Already Exists</div></div>','<div class="add-responsible">','<label for="rs_org">Organization</label><input type="text" id="rs_org" /></div>','<div class="add-responsible">','<label for="rs_phone">Phone</label><input type="text" id="rs_phone" /></div>','<div class="add-responsible">','<label for="rs_street">Street Address</label><input type="text" id="rs_street" /></div>','<div class="add-responsible">','<label for="rs_city">City</label><input type="text" id="rs_city" /></div>','<div class="add-responsible">','<label for="rs_state">State</label><input type="text" id="rs_state" /></div>','<div class="add-responsible">','<label for="rs_zip">Zipcode</label><input type="text" id="rs_zip" /></div>','<div class="add-responsible">','<label for="rs_country">Country</label><input type="text" id="rs_country" /></div>',"</div>",'<div class="modal-footer">','<button class="btn btn-cancel">Cancel</button>','<button class="btn btn-primary">Confirm</button>',"</div>","</div>"].join(""),i=$(r),s=i.modal({show:!0}),o=n.id||n;o.indexOf("@")>=0?$("#rs_email").val(o):$("#rs_name").val(o);i.on("click",".btn-primary",function(e){e.preventDefault();var n=!1;$(".modal #rs_email_dup").removeClass("missing-field-show").addClass("missing-field-hide");$(".modal #rs_email").removeClass("required");$(".modal #rs_email_lbl").removeClass("required");if($(".modal #rs_name").val()==""){$(".modal #rs_name").addClass("required");$(".modal #rs_name_lbl").addClass("required");$(".modal #rs_name_err").addClass("missing-field-show").removeClass("missing-field-hide");n=!0}else{$(".modal #rs_name").removeClass("required");$(".modal #rs_name_lbl").removeClass("required");$(".modal #rs_name_err").removeClass("missing-field-show").addClass("missing-field-hide")}if($(".modal #rs_email").val()==""){$(".modal #rs_email").addClass("required");$(".modal #rs_email_lbl").addClass("required");$(".modal #rs_email_err").addClass("missing-field-show").removeClass("missing-field-hide");$(".modal #rs_email_dup").removeClass("required");n=!0}else{$(".modal #rs_email").removeClass("required");$(".modal #rs_email_lbl").removeClass("required");$(".modal #rs_email_err").removeClass("missing-field-show").addClass("missing-field-hide")}if(!n){var r=JSON.stringify({model:"ResponsibleParty",process:"create",data:{name:$(".modal #rs_name").val(),email:$(".modal #rs_email").val(),organization:$(".modal #rs_org").val(),phone:$(".modal #rs_phone").val(),street:$(".modal #rs_street").val(),city:$(".modal #rs_city").val(),state:$(".modal #rs_state").val(),zip:$(".modal #rs_zip").val(),country:$(".modal #rs_country").val()}});$.ajax({url:"/api/action/additional_metadata",type:"POST",data:r,success:function(e){var n={name:$("#rs_name").val(),email:$("#rs_email").val()},r;if($(t).data("select2").opts.multiple){var i=$(t).data("select2").data();i[i.length-1].id=JSON.stringify(n);i[i.length-1].text=n.name;var o="["+i[0].id;for(var u=1;u<i.length;u++)o+=","+i[u].id;o+="]";$(t).val(o);$(t).trigger("change")}else{$(t).val(JSON.stringify(n));$(t).trigger("change")}s.modal("hide");s.remove()},error:function(e,t,n){$(".modal #rs_email").addClass("required");$(".modal #rs_email_lbl").addClass("required");$(".modal #rs_email_dup").addClass("missing-field-show").removeClass("missing-field-hide")}})}});i.on("click",".btn-cancel",function(e){e.preventDefault();if($(t).data("select2").opts.multiple){var n=$(t).data("select2").data();n.pop();$(t).data("select2").data(n)}else $(t).data("select2").data("");s.modal("hide");s.remove()})}}});