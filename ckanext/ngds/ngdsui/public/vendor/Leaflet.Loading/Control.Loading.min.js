/* Copyright (c) 2014, Siemens Coporate Technology and Arizona Geological Survey */
L.Control.Loading=L.Control.extend({options:{position:"topleft",separate:false,zoomControl:null},initialize:function(a){L.setOptions(this,a);this._dataLoaders={};if(this.options.zoomControl!==null){this.zoomControl=this.options.zoomControl}},onAdd:function(c){this._addLayerListeners(c);this._addMapListeners(c);if(!this.options.separate&&!this.zoomControl){this.zoomControl=c.zoomControl}var b="leaflet-control-loading";var a;if(this.zoomControl&&!this.options.separate){a=this.zoomControl._container;b+=" leaflet-bar-part-bottom leaflet-bar-part last"}else{a=L.DomUtil.create("div","leaflet-control-zoom leaflet-bar")}this._indicator=L.DomUtil.create("a",b,a);return a},onRemove:function(a){this._removeLayerListeners(a);this._removeMapListeners(a)},removeFrom:function(a){if(this.zoomControl&&!this.options.separate){this._container.removeChild(this._indicator);this._map=null;this.onRemove(a);return this}else{return L.Control.prototype.removeFrom.call(this,a)}},addLoader:function(a){this._dataLoaders[a]=true;this.updateIndicator()},removeLoader:function(a){delete this._dataLoaders[a];this.updateIndicator()},updateIndicator:function(){if(this.isLoading()){this._showIndicator()}else{this._hideIndicator()}},isLoading:function(){return this._countLoaders()>0},_countLoaders:function(){var b=0,a;for(a in this._dataLoaders){if(this._dataLoaders.hasOwnProperty(a)){b++}}return b},_showIndicator:function(){L.DomUtil.addClass(this._indicator,"is-loading");if(this.zoomControl&&!this.options.separate){L.DomUtil.removeClass(this.zoomControl._zoomOutButton,"leaflet-bar-part-bottom")}},_hideIndicator:function(){L.DomUtil.removeClass(this._indicator,"is-loading");if(this.zoomControl&&!this.options.separate){L.DomUtil.addClass(this.zoomControl._zoomOutButton,"leaflet-bar-part-bottom")}},_handleLoading:function(a){this.addLoader(this.getEventId(a))},_handleLoad:function(a){this.removeLoader(this.getEventId(a))},getEventId:function(a){if(a.id){return a.id}else{if(a.layer){return a.layer._leaflet_id}}return a.target._leaflet_id},_layerAdd:function(a){if(!a.layer||!a.layer.on){return}a.layer.on({loading:this._handleLoading,load:this._handleLoad},this)},_addLayerListeners:function(a){a.eachLayer(function(b){if(!b.on){return}b.on({loading:this._handleLoading,load:this._handleLoad},this)},this);a.on("layeradd",this._layerAdd,this)},_removeLayerListeners:function(a){a.eachLayer(function(b){if(!b.off){return}b.off({loading:this._handleLoading,load:this._handleLoad},this)},this);a.off("layeradd",this._layerAdd,this)},_addMapListeners:function(a){a.on({dataloading:this._handleLoading,dataload:this._handleLoad},this)},_removeMapListeners:function(a){a.off({dataloading:this._handleLoading,dataload:this._handleLoad},this)}});L.Map.addInitHook(function(){if(this.options.loadingControl){this.loadingControl=new L.Control.Loading();this.addControl(this.loadingControl)}});L.Control.loading=function(a){return new L.Control.Loading(a)};
